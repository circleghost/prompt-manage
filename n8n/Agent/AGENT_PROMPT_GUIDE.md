---
author: 元魁
version: 1.0.0
language: 中文
description: 多代理系統 Prompt 設計與優化指南
tags: [prompt-engineering, multi-agent, orchestrator, sub-agent, best-practices]
created_date: 2025-09-28
updated_date: 2025-09-28
---

# Agent Prompt 設計與優化指南

## 📋 概述

本指南提供多代理系統中 Prompt 設計的最佳實踐，涵蓋主代理（Orchestrator）和子代理（Sub Agent）的設計原則、格式規範、協作模式等核心要素。

## 🎯 設計原則

### 核心理念
- **職責分離**：每個 Agent 專注於特定領域，避免功能重疊
- **通訊標準化**：使用統一的 JSON 格式進行 Agent 間通訊
- **執行彈性**：保持智能判斷能力，避免過度約束
- **錯誤容錯**：優雅處理異常情況，提供替代方案
- **用戶體驗**：個性化回應，符合平台特性（如 Line 格式）

### 設計階層
```
用戶自然語言
    ↓
主代理（理解、規劃、協調）
    ↓
JSON 指令（結構化、靈活）
    ↓  
子代理（執行、回傳）
    ↓
結構化結果
    ↓
主代理（個性化回應）
    ↓
用戶友好輸出
```

## 🏗️ 主代理（Orchestrator）設計規範

### 1. 基本結構

#### 必要組件
```markdown
## 描述
- 角色定位：智能助理的身份和個性
- 核心職責：理解需求、協調子代理、個性化回應

## 工具與代理清單
- 一般工具：需要詳細參數的直接工具
- 智能代理：使用 JSON 指令的子代理

## JSON 指令生成策略
- 指令格式範本
- 生成原則
- 確認流程

## 個性化互動風格
- 身份定位
- 語言風格
- 回應模式

## 輸出格式規範
- Line 格式要求
- Markdown 禁用說明
```

### 2. JSON 指令格式範本

#### 標準格式
```json
{
  "action": "操作類型",
  "intent": "用戶意圖的完整自然語言描述",
  "hints": {
    "確定的關鍵資訊": "具體值",
    "偏好和建議": "彈性值",
    "可選參數": "提示值"
  },
  "context": {
    "original_request": "用戶原始請求",
    "missing_info": ["缺失資訊列表"],
    "filled_defaults": ["已填充的默認值"]
  }
}
```

#### Hints 設計原則
- **必要資訊明確化**：避免模糊解析
- **執行細節保持彈性**：讓子代理自主判斷
- **參數可選性**：只傳遞確定的資訊

### 3. 個性化設計要素

#### 語言風格指引
```markdown
- **語調**：親切但專業
- **表達**：簡潔明確，避免冗長
- **emoji 使用**：適度增加親和力
- **建議提供**：主動提供合理替代方案
```

#### 回應模式範本
```markdown
- **成功時**：簡潔報告結果 + 相關建議
- **確認時**：直接轉發代理訊息，不添加額外內容
- **錯誤時**：耐心說明問題 + 提供1-2個解決方案
- **模糊時**：主動詢問補充資訊
```

## 🔧 子代理（Sub Agent）設計規範

### 1. 基本結構

#### 必要組件
```markdown
## 描述
- 專業領域定位
- 輸入格式說明（JSON 指令）
- 輸出格式規範

## JSON 輸入格式規範
- 基本結構定義
- 支援的 Action 類型
- 輸入範例

## 智能處理機制
- 領域特定的智能功能
- 執行邏輯和決策原則

## 工具調用規範
- 工具列表和格式
- 調用原則和錯誤處理

## 輸出格式
- JSON 回應結構
- 狀態碼定義
- Line 格式要求
```

### 2. JSON 輸入處理原則

#### 解析策略
```markdown
- **解析 action**：確定操作類型和執行路徑
- **理解 intent**：掌握用戶完整意圖和背景
- **運用 hints**：靈活決定具體執行參數
- **參考 context**：了解原始需求和限制條件
- **保持智能**：維持既有的智能判斷功能
```

#### 執行原則
```markdown
- **參數靈活性**：hints 作為建議而非強制約束
- **智能補充**：自動補充合理的缺失參數
- **錯誤容錯**：優雅處理參數不足或衝突
- **結果完整**：提供充分的執行結果資訊
```

### 3. 智能處理機制設計

#### 通用智能功能
```markdown
- **模糊匹配**：處理不完整或近似的輸入
- **自動補全**：智能填充缺失的必要資訊
- **衝突檢測**：識別和處理各種衝突情況
- **建議生成**：提供替代方案和優化建議
```

#### 領域特定功能
```markdown
- **Calendar Agent**：
  - 智能活動識別與比對
  - 自主建立事件決策
  - Google Meet 智能判斷
  - 標題自動簡化

- **GroupChat Agent**：
  - 群組名稱模糊匹配
  - 時間範圍智能推測
  - 關鍵字語意搜尋

- **Image Recognition Agent**：
  - 內容類型自動識別
  - 結構化資料智能提取
  - 多格式輸出適配
```

## 📝 輸出格式統一規範

### Line 平台要求

#### 禁用格式
```markdown
❌ **粗體**、*斜體*
❌ [連結](url)
❌ `代碼`
❌ ```代碼塊```
❌ - [ ] 核取方塊
❌ 1. 2. 3. 數字清單
```

#### 建議格式
```markdown
✅ 純文字 + emoji
✅ • 或 - 開頭的清單
✅ 換行和空行排版
✅ emoji 符號強調（⚠️❌✅📅🔍）
```

#### 範例對照

**❌ 錯誤格式**：
```
**會議已建立** ✅
- [x] 標題：產品討論
- [x] 時間：`明天 14:00-15:00`
- [x] 連結：[Google Meet](https://meet.google.com/xxx)
```

**✅ 正確格式**：
```
會議已建立 ✅
• 標題：產品討論
• 時間：明天 14:00-15:00  
• 連結：https://meet.google.com/xxx
```

### JSON 回應格式

#### 標準結構
```json
{
  "status": "success|error|conflict_detected|needs_user_confirmation|pending_confirmation",
  "operation": "具體操作名稱",
  "message": "符合 Line 格式的中文回應",
  "data": {
    "執行結果的詳細資訊": "具體值"
  }
}
```

#### 狀態碼定義
```markdown
- **success**：操作成功完成
- **error**：操作失敗，包含錯誤說明
- **conflict_detected**：檢測到衝突，提供替代方案
- **needs_user_confirmation**：需要用戶確認後執行
- **pending_confirmation**：等待用戶二次確認（高風險操作）
```

## 🔄 Agent 間協作模式

### 1. 通訊協議

#### 主代理 → 子代理
```json
{
  "agent_type": "calendar|groupchat|image_recognition",
  "instruction": {
    "action": "操作類型",
    "intent": "用戶意圖",
    "hints": {},
    "context": {}
  }
}
```

#### 子代理 → 主代理
```json
{
  "status": "狀態碼",
  "operation": "操作名稱", 
  "message": "Line 格式回應",
  "data": {},
  "metadata": {
    "agent_id": "子代理識別",
    "execution_time": "執行時間",
    "confidence": "執行信心度"
  }
}
```

### 2. 錯誤處理機制

#### 主代理責任
```markdown
- **參數驗證**：確保 JSON 指令格式正確
- **錯誤轉譯**：將技術錯誤轉為用戶友好說明
- **替代方案**：提供 1-2 個具體的解決建議
- **用戶引導**：協助用戶提供缺失資訊
```

#### 子代理責任
```markdown
- **參數容錯**：優雅處理不完整或錯誤參數
- **詳細回報**：提供充分的錯誤診斷資訊
- **建議生成**：根據專業知識提供解決方案
- **狀態管理**：正確設定回應狀態碼
```

### 3. 確認流程設計

#### 單次確認（一般操作）
```
用戶請求 → 主代理分析 → 提供確認訊息 → 用戶確認 → 執行 → 結果回報
```

#### 雙次確認（高風險操作）
```
用戶請求 → 主代理分析 → 子代理檢查 → 第一次確認 → 用戶確認 → 子代理準備 → 第二次確認 → 用戶確認 → 執行 → 結果回報
```

## 🎨 範例與範本

### 主代理範例

#### 用戶請求處理
```markdown
用戶：「明天下午幫我安排一個會議，和張經理討論Q4規劃」

處理步驟：
1. 意圖識別：會議安排 → Calendar Agent
2. 資訊提取：時間偏好、參與者、主題
3. 默認值填充：平台=Google Meet、時長=1小時
4. JSON 指令生成
5. 個性化確認回應
```

#### JSON 指令生成
```json
{
  "action": "create_event",
  "intent": "建立明天下午與張經理討論Q4規劃的會議",
  "hints": {
    "summary": "與張經理討論Q4規劃",
    "date": "2025-09-29",
    "time_preference": "下午",
    "duration": "1小時",
    "meeting_type": "線上會議",
    "attendees_note": "張經理（email待提供）"
  },
  "context": {
    "original_request": "明天下午幫我安排一個會議，和張經理討論Q4規劃",
    "missing_info": ["張經理email"]
  }
}
```

### 子代理範例

#### Calendar Agent 處理
```markdown
接收 JSON 指令 →
解析：action=create_event, 時間偏好=下午 →
智能判斷：14:00-15:00 最適合 →
檢查衝突：無衝突 →
執行 create_event 工具 →
回傳成功結果
```

#### 回應格式
```json
{
  "status": "success",
  "operation": "create_event",
  "message": "📅 與張經理討論Q4規劃 已建立\n• 日期：9月29日（週日）\n• 時間：14:00-15:00\n• 平台：Google Meet\n• 連結：https://meet.google.com/xxx",
  "data": {
    "event_id": "abc123",
    "title": "與張經理討論Q4規劃",
    "start_time": "2025-09-29T14:00:00+08:00",
    "end_time": "2025-09-29T15:00:00+08:00",
    "meet_link": "https://meet.google.com/xxx"
  }
}
```

## 🔍 品質檢核清單

### 主代理檢核項目
- [ ] 個性化設定明確（身份、語調、風格）
- [ ] JSON 指令格式範本完整
- [ ] 工具與代理分類清楚
- [ ] 槽位填充邏輯合理
- [ ] 錯誤處理機制完善
- [ ] Line 格式規範正確
- [ ] 範例涵蓋主要場景

### 子代理檢核項目
- [ ] JSON 輸入格式規範明確
- [ ] 智能處理機制詳細
- [ ] 工具調用格式正確
- [ ] 錯誤處理容錯性良好
- [ ] 輸出格式符合 Line 要求
- [ ] 領域專業功能完整
- [ ] 與主代理協作順暢

### 系統整體檢核項目
- [ ] Agent 間職責分工清晰
- [ ] 通訊協議統一標準
- [ ] 確認流程設計合理
- [ ] 用戶體驗流暢自然
- [ ] 錯誤恢復機制健全
- [ ] 擴展性和維護性良好

## 📚 最佳實踐建議

### 1. Prompt 設計
- **模組化設計**：將功能拆分為獨立模組，便於維護
- **版本控制**：明確標記版本號和更新記錄
- **範例豐富**：提供充足的正面和負面範例
- **持續優化**：基於實際使用情況不斷改進

### 2. JSON 指令設計
- **語意明確**：action 和 intent 要清楚表達目的
- **參數彈性**：hints 作為建議而非強制約束
- **上下文完整**：context 提供充分的背景資訊
- **錯誤友好**：容忍參數不完整或格式錯誤

### 3. 錯誤處理
- **用戶友好**：將技術錯誤轉為易懂的說明
- **建議導向**：提供具體的解決方案而非僅是錯誤描述
- **優雅降級**：在部分功能失效時仍能提供基本服務
- **記錄詳細**：保留充分的除錯資訊

### 4. 性能優化
- **並行處理**：不相關的操作可以並行執行
- **快取機制**：常用資料和結果適當快取
- **負載平衡**：合理分配各 Agent 的工作負載
- **監控告警**：建立系統健康監控機制

## 🚀 未來擴展指引

### 新增子代理流程
1. **需求分析**：確定新領域的核心功能需求
2. **JSON 格式設計**：定義專用的 action 和 hints 結構
3. **智能功能規劃**：設計領域特定的智能處理能力
4. **工具集成**：整合相關的 API 和工具
5. **測試驗證**：全面測試各種場景和邊界條件
6. **文檔更新**：更新本指南和相關文檔

### 系統擴展考量
- **代理發現機制**：自動發現和註冊新的子代理
- **動態路由**：基於能力和負載的智能路由
- **版本相容性**：向下相容的協議升級策略
- **多語言支援**：國際化和本地化考量

## 📖 參考資源

### 相關文件
- `orchestrator-agent.md` - 主代理實作範例
- `calendar-agent.md` - 子代理實作範例
- `calendar-test-scenarios.md` - 測試場景設計

### 開發工具
- JSON Schema 驗證工具
- Prompt 測試框架
- Agent 性能監控工具
- 多代理協作除錯工具

---

## 更新記錄
- v1.0.0 (2025-09-28): 初版發布 - 多代理系統 Prompt 設計完整指南

---

**注意**: 本指南會根據實際使用經驗和技術發展持續更新，建議定期檢視最新版本。
